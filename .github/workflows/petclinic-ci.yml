name: Petclinic CI/CD

on:
  push:
    branches: [main]
    tags:
      - 'v*'  # v1.0.0, v2.0.0 Îì± ÌÉúÍ∑∏ Ìë∏Ïãú Ïãú Ìä∏Î¶¨Í±∞
  pull_request:
    branches: [main]

env:
  # AWS
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: 946775837287.dkr.ecr.ap-northeast-2.amazonaws.com
  ECR_REPO_PREFIX: petclinic-msa
  # GCP
  GCP_PROJECT_ID: kdt2-final-project-t1
  GCP_REGION: asia-northeast3
  GAR_REGISTRY: asia-northeast3-docker.pkg.dev
  GAR_REPO: petclinic-msa
  # Slack
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

permissions:
  id-token: write   # OIDC ÌÜ†ÌÅ∞ Î∞úÍ∏â
  contents: read    # Î†àÌè¨ Ï≤¥ÌÅ¨ÏïÑÏõÉ

jobs:
  # ============================================
  # Î≥ÄÍ≤Ω Í∞êÏßÄ
  # ============================================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      config-server: ${{ steps.changes.outputs.config-server }}
      discovery-server: ${{ steps.changes.outputs.discovery-server }}
      customers-service: ${{ steps.changes.outputs.customers-service }}
      vets-service: ${{ steps.changes.outputs.vets-service }}
      visits-service: ${{ steps.changes.outputs.visits-service }}
      api-gateway: ${{ steps.changes.outputs.api-gateway }}
      admin-server: ${{ steps.changes.outputs.admin-server }}
      any-service: ${{ steps.changes.outputs.any-service }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect Changes
        id: changes
        run: |
          # Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "ALL")
          echo "Changed files: $CHANGED"

          # Ï†ÑÏ≤¥ ÎπåÎìú Ï°∞Í±¥ (Î£®Ìä∏ pom.xmlÎßå - ÏõåÌÅ¨ÌîåÎ°úÏö∞ Î≥ÄÍ≤ΩÏùÄ Ï†úÏô∏)
          if echo "$CHANGED" | grep -qE "^pom.xml$"; then
            echo "üîÑ Ï†ÑÏ≤¥ ÎπåÎìú Ìä∏Î¶¨Í±∞ (pom.xml Î≥ÄÍ≤Ω)"
            BUILD_ALL=true
          else
            BUILD_ALL=false
          fi

          # Í∞Å ÏÑúÎπÑÏä§ Î≥ÄÍ≤Ω Í∞êÏßÄ (ÏÑúÎπÑÏä§Î≥Ñ ÎèÖÎ¶Ω ÎπåÎìú)
          check_service() {
            local service=$1
            if [ "$BUILD_ALL" = "true" ] || echo "$CHANGED" | grep -q "spring-petclinic-$service"; then
              echo "true"
            else
              echo "false"
            fi
          }

          echo "config-server=$(check_service config-server)" >> $GITHUB_OUTPUT
          echo "discovery-server=$(check_service discovery-server)" >> $GITHUB_OUTPUT
          echo "customers-service=$(check_service customers-service)" >> $GITHUB_OUTPUT
          echo "vets-service=$(check_service vets-service)" >> $GITHUB_OUTPUT
          echo "visits-service=$(check_service visits-service)" >> $GITHUB_OUTPUT
          echo "api-gateway=$(check_service api-gateway)" >> $GITHUB_OUTPUT
          echo "admin-server=$(check_service admin-server)" >> $GITHUB_OUTPUT

          # ÌïòÎÇòÎùºÎèÑ Î≥ÄÍ≤ΩÎêòÏóàÎäîÏßÄ
          if [ "$BUILD_ALL" = "true" ] || echo "$CHANGED" | grep -q "spring-petclinic-"; then
            echo "any-service=true" >> $GITHUB_OUTPUT
          else
            echo "any-service=false" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "### üîç Î≥ÄÍ≤Ω Í∞êÏßÄ Í≤∞Í≥º" >> $GITHUB_STEP_SUMMARY
          echo "| ÏÑúÎπÑÏä§ | ÎπåÎìú |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| config-server | ${{ steps.changes.outputs.config-server }} |" >> $GITHUB_STEP_SUMMARY
          echo "| discovery-server | ${{ steps.changes.outputs.discovery-server }} |" >> $GITHUB_STEP_SUMMARY
          echo "| customers-service | ${{ steps.changes.outputs.customers-service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vets-service | ${{ steps.changes.outputs.vets-service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| visits-service | ${{ steps.changes.outputs.visits-service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| api-gateway | ${{ steps.changes.outputs.api-gateway }} |" >> $GITHUB_STEP_SUMMARY
          echo "| admin-server | ${{ steps.changes.outputs.admin-server }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Maven ÎπåÎìú
  # ============================================
  build:
    needs: detect-changes
    if: needs.detect-changes.outputs.any-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Maven Build
        run: |
          chmod +x mvnw
          ./mvnw clean package -DskipTests -q

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jar-files
          path: |
            spring-petclinic-*/target/*.jar
          retention-days: 1

  # ============================================
  # Docker ÎπåÎìú & ECR Push
  # ============================================
  docker-push:
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.any-service == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.set-tag.outputs.tag }}
      built-services: ${{ steps.build-images.outputs.built-services }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: jar-files
          path: .

      - name: Set Image Tag
        id: set-tag
        run: |
          TAG="${{ github.run_number }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "üè∑Ô∏è Image Tag: $TAG"

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Configure GCP Credentials (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Login to Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GAR_REGISTRY }} --quiet

      - name: Build & Push Images
        id: build-images
        env:
          IMAGE_TAG: ${{ steps.set-tag.outputs.tag }}
          BUILD_CONFIG_SERVER: ${{ needs.detect-changes.outputs.config-server }}
          BUILD_DISCOVERY_SERVER: ${{ needs.detect-changes.outputs.discovery-server }}
          BUILD_CUSTOMERS_SERVICE: ${{ needs.detect-changes.outputs.customers-service }}
          BUILD_VETS_SERVICE: ${{ needs.detect-changes.outputs.vets-service }}
          BUILD_VISITS_SERVICE: ${{ needs.detect-changes.outputs.visits-service }}
          BUILD_API_GATEWAY: ${{ needs.detect-changes.outputs.api-gateway }}
          BUILD_ADMIN_SERVER: ${{ needs.detect-changes.outputs.admin-server }}
          GCP_PROJECT_ID: ${{ env.GCP_PROJECT_ID }}
          GAR_REGISTRY: ${{ env.GAR_REGISTRY }}
          GAR_REPO: ${{ env.GAR_REPO }}
          IS_TAGGED_RELEASE: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: |
          BUILT_SERVICES=""

          build_and_push() {
            local service=$1
            local port=$2
            local build_flag=$3

            if [ "$build_flag" != "true" ]; then
              echo "‚è≠Ô∏è Skipping $service (Î≥ÄÍ≤Ω ÏóÜÏùå)"
              return
            fi

            echo "üê≥ Building $service..."

            cd spring-petclinic-$service

            cat > Dockerfile << 'EOF'
          FROM eclipse-temurin:17-jdk-alpine AS build
          WORKDIR /app
          COPY target/*.jar app.jar
          RUN java -Djarmode=layertools -jar app.jar extract

          FROM eclipse-temurin:17-jre-alpine
          WORKDIR /app
          COPY --from=build /app/dependencies/ ./
          COPY --from=build /app/spring-boot-loader/ ./
          COPY --from=build /app/snapshot-dependencies/ ./
          COPY --from=build /app/application/ ./
          EXPOSE $port
          ENTRYPOINT ["java", "org.springframework.boot.loader.launch.JarLauncher"]
          EOF

            # AWS ECR
            ECR_IMAGE="${ECR_REGISTRY}/${ECR_REPO_PREFIX}/petclinic-$service"
            # GCP Artifact Registry
            GAR_IMAGE="${GAR_REGISTRY}/${GCP_PROJECT_ID}/${GAR_REPO}/petclinic-$service"

            # ÎπåÎìú (AWS + GCP ÌÉúÍ∑∏ Î™®Îëê ÏÉùÏÑ±)
            docker build -t $ECR_IMAGE:$IMAGE_TAG -t $ECR_IMAGE:latest \
                         -t $GAR_IMAGE:$IMAGE_TAG -t $GAR_IMAGE:latest .

            # AWS ECR: Ìï≠ÏÉÅ Ìë∏Ïãú (Î™®Îì† Ïª§Î∞ã)
            docker push $ECR_IMAGE:$IMAGE_TAG
            docker push $ECR_IMAGE:latest
            echo "‚úÖ $service ‚Üí AWS ECR ÏôÑÎ£å"

            # GCP Artifact Registry: ÌÉúÍ∑∏Îêú Î¶¥Î¶¨Ïä§Îßå Ìë∏Ïãú (v*.*.*)
            if [ "$IS_TAGGED_RELEASE" = "true" ]; then
              docker push $GAR_IMAGE:$IMAGE_TAG
              docker push $GAR_IMAGE:latest
              echo "‚úÖ $service ‚Üí GCP Artifact Registry ÏôÑÎ£å (Î¶¥Î¶¨Ïä§: ${GITHUB_REF#refs/tags/})"
            else
              echo "‚è≠Ô∏è $service ‚Üí GCP Ïä§ÌÇµ (ÌÉúÍ∑∏ ÏóÜÏùå, main Î∏åÎûúÏπò Ïª§Î∞ã)"
            fi

            BUILT_SERVICES="$BUILT_SERVICES $service"

            cd ..
          }

          build_and_push "config-server" "8888" "$BUILD_CONFIG_SERVER"
          build_and_push "discovery-server" "8761" "$BUILD_DISCOVERY_SERVER"
          build_and_push "customers-service" "8081" "$BUILD_CUSTOMERS_SERVICE"
          build_and_push "vets-service" "8083" "$BUILD_VETS_SERVICE"
          build_and_push "visits-service" "8082" "$BUILD_VISITS_SERVICE"
          build_and_push "api-gateway" "8080" "$BUILD_API_GATEWAY"
          build_and_push "admin-server" "9090" "$BUILD_ADMIN_SERVER"

          echo "built-services=$BUILT_SERVICES" >> $GITHUB_OUTPUT
          echo "is-tagged-release=$IS_TAGGED_RELEASE" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "### üê≥ Docker Push Í≤∞Í≥º" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ steps.set-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Built Services:**${{ steps.build-images.outputs.built-services }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS ECR:** ‚úÖ Ìë∏Ïãú ÏôÑÎ£å" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.build-images.outputs.is-tagged-release }}" = "true" ]; then
            echo "- **GCP Artifact Registry:** ‚úÖ Ìë∏Ïãú ÏôÑÎ£å (Î¶¥Î¶¨Ïä§ ÌÉúÍ∑∏)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **GCP Artifact Registry:** ‚è≠Ô∏è Ïä§ÌÇµ (ÌÉúÍ∑∏ ÏóÜÏùå)" >> $GITHUB_STEP_SUMMARY
          fi

      # [Ïä¨Îûô ÏïåÎ¶º] ÎπåÎìú ÎÅùÎÇ¨ÏúºÎãà ÏäπÏù∏Ìï¥Îã¨ÎùºÍ≥† ÏöîÏ≤≠
      - name: Notify Slack for Approval
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ ÎπåÎìú(CI) ÏÑ±Í≥µ! Î∞∞Ìè¨ ÏäπÏù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Image Tag:*\n`${{ steps.set-tag.outputs.tag }}`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Built Services:*\n${{ steps.build-images.outputs.built-services }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Î∞∞Ìè¨ ÏäπÏù∏ÌïòÎü¨ Í∞ÄÍ∏∞",
                        "emoji": true
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "primary"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # ============================================
  # GitOps Î†àÌè¨ ÏóÖÎç∞Ïù¥Ìä∏ (ÏäπÏù∏ ÌõÑ Ïã§Ìñâ)
  # ============================================
  update-gitops:
    needs: [detect-changes, docker-push]
    if: needs.detect-changes.outputs.any-service == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production  # üëà [ÌïµÏã¨] ÏäπÏù∏ ÏóÜÏúºÎ©¥ Ïó¨Í∏∞ÏÑú ÎåÄÍ∏∞
    steps:
      - name: Checkout GitOps Repo
        uses: actions/checkout@v4
        with:
          repository: ParkSeJin0514/petclinic-gitops
          token: ${{ secrets.GITOPS_TOKEN }}
          path: gitops

      - name: Setup yq
        uses: mikefarah/yq@v4

      - name: Update Image Tags
        env:
          IMAGE_TAG: ${{ needs.docker-push.outputs.image-tag }}
          BUILD_CONFIG_SERVER: ${{ needs.detect-changes.outputs.config-server }}
          BUILD_DISCOVERY_SERVER: ${{ needs.detect-changes.outputs.discovery-server }}
          BUILD_CUSTOMERS_SERVICE: ${{ needs.detect-changes.outputs.customers-service }}
          BUILD_VETS_SERVICE: ${{ needs.detect-changes.outputs.vets-service }}
          BUILD_VISITS_SERVICE: ${{ needs.detect-changes.outputs.visits-service }}
          BUILD_API_GATEWAY: ${{ needs.detect-changes.outputs.api-gateway }}
          BUILD_ADMIN_SERVER: ${{ needs.detect-changes.outputs.admin-server }}
          IS_TAGGED_RELEASE: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: |
          cd gitops

          # yqÎ•º ÏÇ¨Ïö©Ìïú Ï†ïÌôïÌïú Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏ ÏóÖÎç∞Ïù¥Ìä∏
          update_tag() {
            local service=$1
            local build_flag=$2
            local kustomization_file=$3

            if [ "$build_flag" = "true" ]; then
              echo "üîÑ Updating $service tag to $IMAGE_TAG in $kustomization_file"
              yq -i "(.images[] | select(.name == \"springcommunity/spring-petclinic-$service\").newTag) = \"$IMAGE_TAG\"" "$kustomization_file"
            fi
          }

          # AWS overlay: Ìï≠ÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏ (Î™®Îì† Ïª§Î∞ã)
          echo "=== Updating AWS overlay (Ìï≠ÏÉÅ) ==="
          for service in config-server discovery-server customers-service vets-service visits-service api-gateway admin-server; do
            build_var="BUILD_$(echo $service | tr '[:lower:]-' '[:upper:]_')"
            update_tag "$service" "${!build_var}" "overlays/aws/kustomization.yaml"
          done
          echo "‚úÖ AWS overlay ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å"

          # GCP overlay: ÌÉúÍ∑∏ Ìë∏Ïãú ÏãúÏóêÎßå ÏóÖÎç∞Ïù¥Ìä∏
          if [ "$IS_TAGGED_RELEASE" = "true" ]; then
            echo "=== Updating GCP overlay (Î¶¥Î¶¨Ïä§ ÌÉúÍ∑∏: ${GITHUB_REF#refs/tags/}) ==="
            for service in config-server discovery-server customers-service vets-service visits-service api-gateway admin-server; do
              build_var="BUILD_$(echo $service | tr '[:lower:]-' '[:upper:]_')"
              update_tag "$service" "${!build_var}" "overlays/gcp/kustomization.yaml"
            done
            echo "‚úÖ GCP overlay ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å"
          else
            echo "‚è≠Ô∏è GCP overlay Ïä§ÌÇµ (ÌÉúÍ∑∏ ÏóÜÏùå, main Î∏åÎûúÏπò Ïª§Î∞ã)"
          fi

          echo ""
          echo "=== AWS overlay kustomization.yaml ==="
          cat overlays/aws/kustomization.yaml
          echo ""
          echo "=== GCP overlay kustomization.yaml ==="
          cat overlays/gcp/kustomization.yaml

      - name: Commit & Push
        env:
          IMAGE_TAG: ${{ needs.docker-push.outputs.image-tag }}
          BUILT_SERVICES: ${{ needs.docker-push.outputs.built-services }}
        run: |
          cd gitops
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"

          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üöÄ Update [$BUILT_SERVICES ] to tag $IMAGE_TAG"
            git push
            echo "‚úÖ GitOps ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å"
          fi

      - name: Summary
        env:
          IS_TAGGED_RELEASE: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: |
          echo "### üìù GitOps ÏóÖÎç∞Ïù¥Ìä∏" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ needs.docker-push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Updated Services:** ${{ needs.docker-push.outputs.built-services }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS overlay:** ‚úÖ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å" >> $GITHUB_STEP_SUMMARY
          if [ "$IS_TAGGED_RELEASE" = "true" ]; then
            echo "- **GCP overlay:** ‚úÖ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å (Î¶¥Î¶¨Ïä§ ÌÉúÍ∑∏)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **GCP overlay:** ‚è≠Ô∏è Ïä§ÌÇµ (ÌÉúÍ∑∏ ÏóÜÏùå)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **ArgoCDÍ∞Ä ÏûêÎèôÏúºÎ°ú KubernetesÏóê Î∞∞Ìè¨Ìï©ÎãàÎã§**" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Slack ÏïåÎ¶º - Î∞∞Ìè¨ ÏôÑÎ£å
  # ============================================
  notify-deploy-complete:
    needs: [detect-changes, docker-push, update-gitops]
    if: needs.detect-changes.outputs.any-service == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification - Deploy Complete
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ Î∞∞Ìè¨ ÏôÑÎ£å",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Image Tag:*\n`${{ needs.docker-push.outputs.image-tag }}`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Built Services:*\n${{ needs.docker-push.outputs.built-services }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\nArgoCD ÏûêÎèô Î∞∞Ìè¨ Ï§ë"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "üéâ GitOps Î†àÌè¨ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å! ArgoCDÍ∞Ä ÏûêÎèôÏúºÎ°ú Î∞∞Ìè¨Ìï©ÎãàÎã§."
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
